<?php
// Connect to the database
$host = 'localhost';
$user = 'root';
$pass = '4z@auGqVnPPDNxFBq#';
$dbname = 'IDNPentest';

$conn = new mysqli($host, $user, $pass, $dbname);

// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Get category from URL parameter or set default value
$category = isset($_GET['kategori']) ? $_GET['kategori'] : 'kebersihan';

// Construct the SQL query
$query = "SELECT * FROM products WHERE category = '$category' AND released = 1";
// Debugging: Output the SQL query
echo "<p>SQL Query: $query</p>";

// execute query
$result = $conn->query($query);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Injection Lab - Retrieve Hidden Data</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">SQL Injection Lab: Retrieve Hidden Data</h1>
        <p class="text-center text-muted">Memanfaatkan Kerentanan SQL Injection untuk mendapatkan data produk yang belum rilis.</p>
        
        <div class="card mt-4">
            <div class="card-header">
                <!-- Prevent XSS using htmlspecialchars -->
                <h4>Kategori: <?php echo htmlspecialchars($category); ?></h4>
            </div>
            <div class="card-body">
                <!-- Fetch data dari database -->
                <?php
                if ($result !== false && $result->num_rows > 0) {
                    echo '<div class="list-group">';
                    while($row = $result->fetch_assoc()) {
                        echo '<a href="#" class="list-group-item list-group-item-action">';
                        echo '<h5 class="mb-1">' . htmlspecialchars($row["product_name"]) . '</h5>';
                        echo '<p class="mb-1">Price: $' . htmlspecialchars($row["price"]) . '</p>';
                        echo '<small>' . htmlspecialchars($row["description"]) . '</small>';
                        echo '</a>';
                    }
                    echo '</div>';
                } else {
                    echo '<div class="alert alert-warning" role="alert">';
                    echo "No products found in the '" . htmlspecialchars($category) . "' category.";
                    echo '</div>';
                }
                ?>
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <a href="sqli_retrieve_hidden_data.php?kategori=kebersihan" class="btn btn-primary">Produk Kebersihan</a>
            <a href="sqli_retrieve_hidden_data.php?kategori=komputer" class="btn btn-primary">Produk Komputer</a>
            <a href="sqli_retrieve_hidden_data.php?kategori=furniture" class="btn btn-primary">Produk Furniture</a>
        </div>
        <br>
        <br>
        <div class="card mt-4">
            <div class="card-header">
                <h4>Exploitasi Kerentanan</h4>
            </div>
            <div class="card-body">
                <p>1. Pada Query yang ditunjukkan di atas <code>AND released = 1</code> membatasi agar produk yang ditunjukkan hanyalah produk yang telah rilis </p>
                <p>2. Karena kita memiliki kendali penuh atas nilai dari kategori, maka kita bisa melihat semua produk termasuk yang belum rilis dengan cara
                    <code>php?kategori=kebersihan'--</code> atau dengan cara ini <code>php?kategori=kebersihan' OR 1=1--'</code></p>
                </p>
                <p>3. Dibawah merupakan gambar table products berisi semua data produk yang belum dan sudah rilis</p>
                <img src="products_data.png" alt="" width="480px">
            </div>
        </div>
        <br>
        <br>
        <!-- Kembali ke halaman utama -->
        <div class="text-center">
        <a href="index.php" class="btn btn btn-info my-4">Kembali ke Main Page</a>
    </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>

<?php
$conn->close();
?>
