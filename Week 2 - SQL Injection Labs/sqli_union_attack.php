<?php
// Connect to the database
$host = 'localhost';
$user = 'root';
$pass = '4z@auGqVnPPDNxFBq#';
$dbname = 'IDNPentest';

$conn = new mysqli($host, $user, $pass, $dbname);

// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Get category from URL parameter or set default value
$category = isset($_GET['kategori']) ? $_GET['kategori'] : 'kebersihan';

// Construct the SQL query
$query = "SELECT * FROM products WHERE category = '$category'";
// Debugging: Output the SQL query
echo "<p>SQL Query: $query</p>";

// Execute the query
$result = $conn->query($query);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Injection Lab: UNION Attack</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">SQL Injection Lab - UNION Attack</h1>
        <p class="text-center text-muted">Memanfaatkan Kerentanan SQL Injection untuk membaca table lain dari database.</p>
        
        <div class="card mt-4">
            <div class="card-header">
                <!-- Prevent XSS using htmlspecialchars -->
                <h4>Kategori: <?php echo htmlspecialchars($category); ?></h4>
            </div>
            <div class="card-body">
                <!-- Fetch data dari database -->
                <?php
                // fixing error here
                // if ( $result !== false && $result->num_rows > 0)
                if ($result->num_rows > 0) {
                    echo '<div class="list-group">';
                    while($row = $result->fetch_assoc()) {
                        echo '<a href="#" class="list-group-item list-group-item-action">';
                        echo '<h5 class="mb-1">' . htmlspecialchars($row["product_name"]) . '</h5>';
                        echo '<p class="mb-1">Price: $' . htmlspecialchars($row["price"]) . '</p>';
                        echo '<small>' . htmlspecialchars($row["description"]) . '</small>';
                        echo '</a>';
                    }
                    echo '</div>';
                } else {
                    echo '<div class="alert alert-warning" role="alert">';
                    echo "No products found in the '" . htmlspecialchars($category) . "' category.";
                    echo '</div>';
                }
                ?>
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <a href="sqli_union_attack.php?kategori=kebersihan" class="btn btn-primary">Produk Kebersihan</a>
            <a href="sqli_union_attack.php?kategori=komputer" class="btn btn-primary">Produk Komputer</a>
            <a href="sqli_union_attack.php?kategori=furniture" class="btn btn-primary">Produk Furniture</a>
        </div>
        <br>
        <br>
        <div class="card mt-4">
            <div class="card-header">
                <h4>Exploitasi Kerentanan</h4>
            </div>
            <div class="card-body">
                <p>1. Pada Halaman ini, penyerang bisa menggunakan kerentanan SQL Injection untuk mendapatkan data dari table lain didalam database dengan teknik <code>UNION</code> attack</p>
                <p>2. Kita bisa menggunakan keyword <code>UNION</code> untuk mengeksekusi query <code>SELECT</code> tambahan dan menggabungkan hasilnya pada respon dari query awal.</p>
                <p><code>sqli_union_attack.php?kategori=' UNION SELECT username, password FROM users--
                </code></p>
                <p>3. Kita akan memasukkan payload <code>' UNION SELECT username, password FROM users--</code>query string parameter untuk mentrigger agar database mengembalikan semua user dan password bersama dengan data lainnya</p>
            </div>
        </div>
        <br>
        <br>
        <!-- Kembali ke halaman utama -->
        <div class="text-center">
        <a href="index.php" class="btn btn btn-info my-4">Kembali ke Main Page</a>
    </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>

<?php
$conn->close();
?>
